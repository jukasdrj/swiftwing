{
  "name": "Epic 5: Swift OpenAPI Generator Integration",
  "description": "Replace manual URLSession implementations with Apple's official swift-openapi-generator to provide compile-time type safety and automatic API contract synchronization for Talaria backend integration. This epic modernizes the network layer with generated code, eliminating runtime JSON parsing errors and ensuring API contract compatibility.",
  "branchName": "epic/5-openapi-generator",
  "userStories": [
    {
      "id": "US-501",
      "title": "Add swift-openapi-generator Package Dependencies",
      "description": "As a developer, I want to add swift-openapi-generator and its runtime dependencies to the Xcode project so that I can generate type-safe Swift client code from OpenAPI specifications.",
      "acceptanceCriteria": [
        "Add apple/swift-openapi-generator package dependency to Xcode project",
        "Add apple/swift-openapi-runtime package dependency",
        "Add apple/swift-openapi-urlsession for URLSession-based transport",
        "Configure build plugin in target settings",
        "Verify packages resolve and download successfully",
        "Build project to confirm zero errors or warnings from package integration"
      ],
      "priority": 1,
      "estimate": "1 hour",
      "passes": true,
      "notes": "Foundation for OpenAPI-based networking. Must complete before spec fetch work.",
      "dependsOn": [],
      "technicalNotes": [
        "Use File > Add Package Dependencies in Xcode",
        "swift-openapi-generator version: Latest stable (≥1.0.0)",
        "swift-openapi-runtime provides types and protocols for generated code",
        "swift-openapi-urlsession provides URLSession-based client transport",
        "Build plugin automatically generates Swift code during build phase",
        "Package URLs:",
        "  - https://github.com/apple/swift-openapi-generator",
        "  - https://github.com/apple/swift-openapi-runtime",
        "  - https://github.com/apple/swift-openapi-urlsession"
      ],
      "testCoverage": {
        "unitTests": [
          "Build project after package addition",
          "Verify package resolution in Xcode",
          "Check for dependency conflicts"
        ],
        "required": false,
        "estimatedTests": 0
      },
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-502",
      "title": "Commit OpenAPI Spec to Repository and Create Update Script",
      "description": "As a developer, I want the OpenAPI specification committed to the repository with a manual update script so that builds are deterministic, offline-capable, and API changes are code-reviewed.",
      "acceptanceCriteria": [
        "Create scripts/update-api-spec.sh to fetch openapi.yaml from Talaria",
        "Initial spec committed to swiftwing/OpenAPI/talaria-openapi.yaml",
        "Script includes checksum verification for integrity",
        "Script requires explicit --force flag to overwrite existing spec",
        "Update .gitignore to track OpenAPI/*.yaml (remove Generated/ entry)",
        "Document spec update workflow in CLAUDE.md",
        "Build phase reads from committed spec, does not fetch remotely"
      ],
      "priority": 2,
      "estimate": "2 hours",
      "passes": true,
      "notes": "CRITICAL FIX from consensus review: Build-time spec fetching breaks offline dev, introduces supply chain security risk, and makes builds non-deterministic. Committing spec enables code review of API changes.",
      "dependsOn": [
        "US-501"
      ],
      "technicalNotes": [
        "Create scripts/update-api-spec.sh with executable permissions (chmod +x)",
        "Script fetches from https://api.oooefam.net/openapi.yaml",
        "Compute SHA256 checksum and compare with previous version",
        "Require --force flag to overwrite: ./update-api-spec.sh --force",
        "Default behavior: fetch → compare → warn if different → exit without overwrite",
        "Commit spec to swiftwing/OpenAPI/talaria-openapi.yaml (version controlled)",
        "Build phase references $(SRCROOT)/swiftwing/OpenAPI/talaria-openapi.yaml",
        "Update workflow: run script → review diff → commit spec update",
        "Security: Checksum verification prevents tampering",
        "Benefits: Offline builds work, API changes visible in PRs, deterministic builds",
        "Example script usage:",
        "  ./scripts/update-api-spec.sh           # Check for updates",
        "  ./scripts/update-api-spec.sh --force   # Update and overwrite"
      ],
      "testCoverage": {
        "unitTests": [
          "Test update script fetches spec successfully",
          "Test checksum verification detects changes",
          "Test --force flag overwrites existing spec",
          "Test build works with committed spec (offline mode)",
          "Test script warns when spec differs from remote"
        ],
        "required": false,
        "estimatedTests": 0
      },
      "completionNotes": "Completed by agent",
      "recommendedTools": [
        "mcp__pal__secaudit - Review script for security vulnerabilities"
      ]
    },
    {
      "id": "US-503",
      "title": "Create OpenAPI Generator Configuration",
      "description": "As a developer, I want to configure swift-openapi-generator settings to produce idiomatic Swift code matching SwiftWing's architecture patterns and Swift 6.2 concurrency requirements.",
      "acceptanceCriteria": [
        "Create openapi-generator-config.yaml in project root",
        "Configure generator to target Swift 6.2 with strict concurrency",
        "Enable async/await code generation for all operations",
        "Configure namespace as TalariaAPI",
        "Enable Server-Sent Events streaming support",
        "Configure generated types to conform to Sendable protocol",
        "Verify configuration syntax is valid"
      ],
      "priority": 3,
      "estimate": "1.5 hours",
      "passes": true,
      "notes": "Configuration determines code generation quality and Swift 6 compatibility.",
      "dependsOn": [
        "US-502"
      ],
      "technicalNotes": [
        "Configuration file format: YAML",
        "Key settings: accessModifier: public, generate: [types, client]",
        "SSE support: Ensure OpenAPI spec includes SSE extensions (may require custom annotations)",
        "Swift 6 concurrency: Generated client methods should be async and Sendable-safe",
        "Generator reads config from project root or target directory",
        "Example config structure:",
        "  generate:",
        "    - types",
        "    - client",
        "  accessModifier: public",
        "  additionalImports:",
        "    - Foundation",
        "File location: $(SRCROOT)/openapi-generator-config.yaml",
        "May also need openapi.yaml in target to trigger plugin"
      ],
      "testCoverage": {
        "unitTests": [
          "Validate YAML syntax",
          "Verify generator recognizes configuration",
          "Test generated code uses configured namespace"
        ],
        "required": false,
        "estimatedTests": 0
      },
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-504",
      "title": "Generate Type-Safe Talaria Client Code",
      "description": "As a developer, I want swift-openapi-generator to automatically create type-safe Swift client code for all Talaria v3 API endpoints so that all network requests are validated at compile time.",
      "acceptanceCriteria": [
        "Generator creates client code in DerivedData during build",
        "Generated code includes all v3 endpoints: POST /v3/jobs/scans, GET /v3/jobs/scans/:jobId/stream, DELETE /v3/jobs/scans/:jobId/cleanup",
        "Generated request/response types match OpenAPI spec exactly",
        "All generated types are immutable (struct-based where appropriate)",
        "Enums generated for known string constants (event types, status codes)",
        "Generated code compiles with zero errors or warnings",
        "Xcode autocomplete works for generated types and methods"
      ],
      "priority": 4,
      "estimate": "2 hours",
      "passes": true,
      "notes": "Core code generation step. Success here validates entire OpenAPI integration approach.",
      "dependsOn": [
        "US-503"
      ],
      "technicalNotes": [
        "Generated code location: $(BUILD_DIR)/GeneratedSources/openapi/",
        "Build plugin handles generation automatically",
        "Types include: Operations, Components.Schemas, path/query/header types",
        "Generated client exposes async methods for each operation",
        "Error types generated from OpenAPI error schemas",
        "Import generated module: import TalariaAPI",
        "If generation fails, check:",
        "  - OpenAPI spec syntax validity",
        "  - Generator config correctness",
        "  - Build phase ordering",
        "Generated code should include:",
        "  - Client struct with async methods",
        "  - Request/response body types",
        "  - Path parameter types",
        "  - Query parameter types",
        "  - Header types"
      ],
      "testCoverage": {
        "unitTests": [
          "Verify generated client compiles",
          "Test generated types are accessible",
          "Verify all expected endpoints are generated",
          "Test Xcode autocomplete for generated API"
        ],
        "required": false,
        "estimatedTests": 0
      },
      "completionNotes": "Completed by agent",
      "recommendedTools": [
        "mcp__pal__codereview - Review generated code quality and patterns"
      ]
    },
    {
      "id": "US-505",
      "title": "Create TalariaService Actor Wrapper",
      "description": "As a developer, I want a TalariaService actor that wraps the generated OpenAPI client to provide actor isolation, domain model translation, and SwiftWing-specific business logic.",
      "acceptanceCriteria": [
        "Create Services/TalariaService.swift as an actor",
        "Actor initializes with generated TalariaAPI.Client instance",
        "Base URL hardcoded to production: https://api.oooefam.net",
        "Implement uploadScan(image:deviceId:) async throws -> (jobId: String, streamUrl: URL)",
        "Implement streamEvents(streamUrl:) -> AsyncThrowingStream<SSEEvent, Error>",
        "Implement cleanup(jobId:) async throws",
        "Translate generated API types to SwiftWing domain models (BookMetadata, SSEEvent)",
        "Map generated error types to NetworkError enum"
      ],
      "priority": 5,
      "estimate": "4 hours",
      "passes": true,
      "notes": "Adapter layer between generated client and SwiftWing domain. Critical for maintainability.",
      "dependsOn": [
        "US-504"
      ],
      "technicalNotes": [
        "Actor provides thread-safe access to OpenAPI client",
        "Client instance: private let client: TalariaAPI.Client",
        "Domain translation: Components.Schemas.BookResult → BookMetadata",
        "SSEEvent enum: .progress(String), .result(BookMetadata), .complete, .error(String)",
        "Error mapping: TalariaAPI.APIError → NetworkError.serverError(Int, String)",
        "Use nonisolated(unsafe) for URLSession access if needed",
        "Keep existing NetworkError types from Epic 4",
        "Initialize client:",
        "  let client = TalariaAPI.Client(",
        "    serverURL: try Servers.server1(),",
        "    transport: URLSessionTransport()",
        "  )",
        "Translation functions should be private helpers in TalariaService"
      ],
      "testCoverage": {
        "unitTests": [
          "Test TalariaService initialization",
          "Test domain model translation (API types → SwiftWing types)",
          "Test error mapping (API errors → NetworkError)",
          "Test actor isolation prevents data races"
        ],
        "required": true,
        "estimatedTests": 4
      },
      "completionNotes": "Completed by agent",
      "recommendedTools": [
        "mcp__pal__debug - Debug actor isolation issues if data races occur"
      ]
    },
    {
      "id": "US-506",
      "title": "Implement SSE Streaming with Generated Client",
      "description": "As a user, I want real-time scan progress updates via Server-Sent Events using the type-safe generated streaming API so that I see live feedback during AI processing.",
      "acceptanceCriteria": [
        "Use swift-openapi-generator's built-in SSE streaming support (if available)",
        "If SSE not natively supported, implement custom AsyncSequence over generated types",
        "streamEvents() returns AsyncThrowingStream<SSEEvent, Error>",
        "Parse event types: progress, completed, failed, canceled",
        "Extract structured data from each event using generated Codable types",
        "Handle stream interruptions with error propagation",
        "Close stream gracefully on completed or failed events",
        "Integration test: Connect to real Talaria SSE stream and parse events"
      ],
      "priority": 6,
      "estimate": "5 hours",
      "passes": true,
      "notes": "Complex async stream parsing. Critical for real-time UX. SSE may require manual implementation.",
      "completionNotes": "Completed by agent - Added canceled event type support, integration test for canceled events, and verified all SSE streaming functionality meets acceptance criteria",
      "dependsOn": [
        "US-505"
      ],
      "technicalNotes": [
        "Check if OpenAPI spec defines SSE endpoint with text/event-stream content type",
        "If generator doesn't support SSE natively, use URLSession.bytes(from:) with generated URL",
        "Parse SSE format: event: <type>\\ndata: <json>\\n\\n",
        "Use generated Codable types for event data payloads",
        "Example: Components.Schemas.ProgressEvent, Components.Schemas.CompletedEvent",
        "Stream must handle network timeouts (5 minute max)",
        "Reconnect logic: exponential backoff (2s, 4s, 8s, max 3 attempts)",
        "AsyncThrowingStream pattern:",
        "  AsyncThrowingStream { continuation in",
        "    Task {",
        "      // Parse SSE lines and yield events",
        "      continuation.finish()",
        "    }",
        "  }",
        "Consider keeping existing SSE parsing logic from Epic 4 if generator doesn't support SSE"
      ],
      "testCoverage": {
        "unitTests": [
          "Test SSE parsing (progress event)",
          "Test SSE parsing (completed event with book data)",
          "Test SSE parsing (failed event)",
          "Test SSE parsing (canceled event)",
          "Test stream timeout handling",
          "Test reconnect logic on stream interruption"
        ],
        "required": true,
        "estimatedTests": 6
      },
      "recommendedTools": [
        "mcp__pal__tracer - Trace SSE event flow and AsyncSequence execution"
      ]
    },
    {
      "id": "US-507",
      "title": "Replace NetworkActor with TalariaService",
      "description": "As a developer, I want to migrate all Talaria API calls from the manual NetworkActor implementation to the new TalariaService wrapper so that all network code uses the generated client.",
      "acceptanceCriteria": [
        "Update CameraViewModel to use TalariaService instead of NetworkActor",
        "Replace all networkActor.uploadImage() calls with talariaService.uploadScan()",
        "Replace SSE stream initialization with talariaService.streamEvents()",
        "Replace cleanup calls with talariaService.cleanup()",
        "Comment out or ifdef NetworkActor usage (DO NOT delete yet)",
        "Keep NetworkActor.swift file until US-509 integration tests pass",
        "Build succeeds with zero errors or warnings",
        "All Epic 4 workflows functional with TalariaService"
      ],
      "priority": 7,
      "estimate": "3 hours",
      "passes": true,
      "notes": "Migration step. Requires careful refactoring to maintain existing functionality. DO NOT delete old code yet - that happens in US-508 AFTER US-509 validates new code works.",
      "dependsOn": [
        "US-506"
      ],
      "recommendedTools": [
        "/planning-with-files - MANDATORY for migration complexity"
      ],
      "technicalNotes": [
        "ROLLBACK PROCEDURES (execute before starting migration):",
        "  1. Create safety tag: git tag pre-openapi-migration",
        "  2. Create migration branch: git checkout -b feat/us-507-migration",
        "  3. Keep NetworkActor.swift until US-509 integration tests pass",
        "  4. If rollback needed: git revert <commit-range> or git reset --hard pre-openapi-migration",
        "",
        "MIGRATION STEPS:",
        "Search for all references to NetworkActor in project",
        "Update dependency injection in ViewModels",
        "TalariaService should be initialized once and reused",
        "Consider adding TalariaService to environment: @Environment(\\.talariaService)",
        "Migration order: upload → streaming → cleanup",
        "Test each migration step before proceeding to next",
        "Keep NetworkError enum if it's used elsewhere",
        "Update CameraViewModel properties:",
        "  - Remove: private let networkActor: NetworkActor",
        "  - Add: private let talariaService: TalariaService",
        "Verify all Epic 4 user stories still work after migration",
        "",
        "DO NOT delete NetworkActor.swift until US-509 passes (moved to US-508)"
      ],
      "testCoverage": {
        "unitTests": [
          "Test upload workflow with TalariaService",
          "Test SSE streaming with TalariaService",
          "Test cleanup with TalariaService",
          "Verify no NetworkActor references remain"
        ],
        "required": true,
        "estimatedTests": 4
      },
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-508",
      "title": "Remove Manual URLSession Code",
      "description": "As a developer, I want to delete all manual URLSession network implementations for Talaria so that the codebase uses only the generated type-safe client.",
      "acceptanceCriteria": [
        "Delete manual multipart form-data encoding functions",
        "Delete manual SSE response parsing logic",
        "Delete custom JSON encoder/decoder configurations for Talaria",
        "Delete NetworkActor.swift (from US-507)",
        "Remove unused URLSession extension methods",
        "Remove manual error parsing for Talaria responses",
        "Verify no URLSession.shared calls remain for Talaria endpoints",
        "Build succeeds with zero errors or warnings"
      ],
      "priority": 9,
      "estimate": "2 hours",
      "passes": true,
      "notes": "Cleanup step. Reduces code complexity and maintenance burden. CRITICAL: Only execute AFTER US-509 integration tests pass. Do not delete old code before validating new code works.",
      "dependsOn": [
        "US-509"
      ],
      "technicalNotes": [
        "PREREQUISITE: US-509 integration tests MUST pass before executing this cleanup",
        "Why this order matters: If new code fails tests, old code is still available for rollback",
        "",
        "Use Xcode 'Find in Project' to search for:",
        "  - URLSession.shared.data",
        "  - multipart/form-data",
        "  - Manual boundary generation",
        "  - SSE parsing state machines",
        "Keep URLSession code for non-Talaria networking (if any)",
        "Run full test suite after deletion",
        "Commit with clear message: 'chore: remove manual URLSession in favor of OpenAPI client'",
        "Files to delete:",
        "  - NetworkActor.swift (kept during US-507, deleted here)",
        "  - Any Talaria-specific extension files",
        "Verify Epic 4 integration tests still pass"
      ],
      "testCoverage": {
        "unitTests": [
          "Run all existing tests after cleanup",
          "Verify no manual URLSession code remains",
          "Check for unused imports"
        ],
        "required": true,
        "estimatedTests": 0
      },
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-509",
      "title": "Integration Testing with Real Talaria API",
      "description": "As a developer, I want to verify the generated client works correctly with the live Talaria backend across all workflows so that I confirm API contract compatibility.",
      "acceptanceCriteria": [
        "Test upload workflow: POST /v3/jobs/scans returns valid jobId and streamUrl",
        "Test SSE stream: Can receive progress, completed, and failed events",
        "Test cleanup: DELETE /v3/jobs/scans/:jobId/cleanup succeeds",
        "Verify generated types correctly deserialize real API responses",
        "Test error cases: network failure, 429 rate limit, 5xx server errors",
        "Test concurrent uploads: 5 simultaneous scans complete successfully",
        "Verify all tests pass in iOS Simulator with real network",
        "Document any OpenAPI spec discrepancies found during testing",
        "PERFORMANCE BENCHMARKS (all tests must meet targets):",
        "  - Upload request latency: < 1000ms (network dependent)",
        "  - SSE first event received: < 500ms after connection",
        "  - Concurrent upload throughput: 5 uploads complete in < 10s",
        "  - SSE parsing CPU usage: < 15% on main thread",
        "  - Memory usage: No leaks during 10-minute streaming session"
      ],
      "priority": 8,
      "estimate": "4 hours",
      "passes": true,
      "notes": "CRITICAL: Comprehensive validation BEFORE cleanup. Ensures generated client matches real API behavior. MUST pass before US-508 deletes old code.",
      "dependsOn": [
        "US-507"
      ],
      "technicalNotes": [
        "Use real test images from SwiftWing's test assets",
        "Test on iOS Simulator (network conditions can be throttled in Xcode)",
        "Monitor network traffic in Charles Proxy or Instruments",
        "Compare request/response format to OpenAPI spec",
        "If spec mismatches occur, update spec and regenerate",
        "Create test suite: SwiftWingTests/Integration/TalariaAPITests.swift",
        "Use XCTestExpectation for async SSE streams",
        "",
        "PERFORMANCE MEASUREMENT:",
        "  - Use CFAbsoluteTimeGetCurrent() for latency measurements",
        "  - Use Instruments Time Profiler for CPU usage",
        "  - Use Instruments Leaks for memory leak detection",
        "  - Log all performance metrics to test output",
        "  - Fail tests if any benchmark target is missed",
        "",
        "Test scenarios:",
        "  1. Happy path: upload → SSE progress → result → cleanup",
        "  2. Error path: upload → SSE failed event",
        "  3. Rate limit: 429 response handling",
        "  4. Concurrent: 5 parallel uploads (measure throughput)",
        "  5. Performance: Measure all benchmarks under load",
        "Document findings in integration test comments"
      ],
      "testCoverage": {
        "unitTests": [
          "Integration test: Upload and receive jobId/streamUrl",
          "Integration test: SSE stream receives all event types",
          "Integration test: Cleanup succeeds",
          "Integration test: Error handling (429, 5xx)",
          "Integration test: Concurrent uploads (5 parallel)",
          "Performance test: Upload latency < 1000ms",
          "Performance test: SSE first event < 500ms",
          "Performance test: Concurrent throughput < 10s",
          "Performance test: CPU usage < 15% during SSE",
          "Performance test: No memory leaks in 10min session"
        ],
        "required": true,
        "estimatedTests": 10
      },
      "recommendedTools": [
        "mcp__pal__testgen - Generate comprehensive integration tests"
      ],
      "completionNotes": "Completed by agent"
    },
    {
      "id": "US-510",
      "title": "Update Documentation and Code Comments",
      "description": "As a developer, I want updated documentation explaining the OpenAPI-based architecture so that future contributors understand the type-safe network layer.",
      "acceptanceCriteria": [
        "Update CLAUDE.md with swift-openapi-generator usage instructions (500+ words)",
        "Add section explaining committed spec + manual update workflow (US-502 changes)",
        "Document TalariaService actor architecture with ASCII diagram",
        "Add code comments to TalariaService explaining domain model translation",
        "Update EPIC-4-STORIES.md to reference OpenAPI migration",
        "Create README in swiftwing/OpenAPI/ explaining spec management",
        "Document rollback procedures from US-507",
        "Add troubleshooting section for common OpenAPI build errors",
        "Document performance benchmarks from US-509",
        "Include security rationale for committed specs vs auto-fetch"
      ],
      "priority": 10,
      "estimate": "2 hours",
      "passes": false,
      "notes": "Documentation is critical for maintainability and onboarding. UPDATED to reflect consensus review changes (committed specs, reordered dependencies, performance benchmarks).",
      "dependsOn": [
        "US-508"
      ],
      "technicalNotes": [
        "CLAUDE.md section: 'Talaria API Integration (OpenAPI-Based)'",
        "Explain why OpenAPI was chosen over manual URLSession",
        "Document committed spec strategy (security, determinism, code review benefits)",
        "Document scripts/update-api-spec.sh usage with examples",
        "Include example of adding new Talaria endpoint",
        "Troubleshooting: generator errors, type mismatches, build failures",
        "README.md in swiftwing/OpenAPI/: Explain spec management workflow",
        "Add to CLAUDE.md:",
        "  - Spec update workflow (./scripts/update-api-spec.sh)",
        "  - Generator configuration options",
        "  - TalariaService architecture diagram (ASCII art)",
        "  - Rollback procedures (git tag, revert commands)",
        "  - Performance benchmarks and measurement approach",
        "  - Common errors and solutions",
        "Update EPIC-4-STORIES.md with migration notes",
        "Document why build-time fetch was rejected (consensus review findings)"
      ],
      "testCoverage": {
        "unitTests": [],
        "required": false,
        "estimatedTests": 0
      },
      "recommendedTools": [
        "mcp__pal__docgen - Generate comprehensive documentation with complexity analysis"
      ]
    }
  ],
  "metadata": {
    "created": "2026-01-24",
    "epic_number": 5,
    "total_epics": 6,
    "estimated_duration": "1-2 weeks (solo dev, part-time)",
    "dependencies": "Epic 4 (US-401 through US-411 - NetworkActor and Talaria integration)",
    "ralph_tui_notes": "This epic has 10 user stories covering OpenAPI-based network layer migration. CRITICAL FIXES APPLIED from consensus review: US-502 now commits specs (not fetch on build), US-509 reordered BEFORE US-508 (test before delete), US-509 includes performance benchmarks. Prioritize US-501 through US-507 for functional completion. US-509 validates, US-508 cleans up, US-510 documents.",
    "architecture_notes": {
      "approach": "Replace manual URLSession with Apple's official swift-openapi-generator",
      "benefits": "Compile-time type safety, automatic API synchronization, reduced boilerplate",
      "pattern": "Generated client wrapped in TalariaService actor for domain translation",
      "concurrency": "Generated code compatible with Swift 6.2 strict concurrency",
      "sse_handling": "May require manual implementation if generator doesn't support SSE natively"
    },
    "openapi_integration": {
      "generator": "apple/swift-openapi-generator (latest stable)",
      "spec_source": "COMMITTED to repository (changed from build-time fetch per consensus review)",
      "spec_location": "swiftwing/OpenAPI/talaria-openapi.yaml (committed, version controlled)",
      "spec_update_script": "scripts/update-api-spec.sh (manual updates only)",
      "generated_code_location": "$(BUILD_DIR)/GeneratedSources/openapi/",
      "namespace": "TalariaAPI",
      "transport": "URLSession (via swift-openapi-urlsession)",
      "security_rationale": "Committed specs enable code review, prevent supply chain attacks, ensure deterministic builds"
    },
    "migration_strategy": {
      "phase_1": "Add packages and configure generator (US-501 to US-504)",
      "phase_2": "Create adapter layer and migrate code (US-505 to US-507)",
      "phase_3": "VALIDATE FIRST, then cleanup (US-509 → US-508 → US-510)",
      "rollback_plan": "git tag pre-openapi-migration before US-507, keep NetworkActor until US-509 passes",
      "dependency_fix": "CRITICAL: US-509 (test) moved BEFORE US-508 (delete). Do not burn bridge before crossing."
    },
    "test_coverage_strategy": {
      "unit_tests_required": 4,
      "total_estimated_tests": 24,
      "integration_tests": 10,
      "performance_tests": 5,
      "coverage_target": "100% for TalariaService adapter layer, rely on generated code quality for client",
      "performance_benchmarks": {
        "upload_latency": "< 1000ms",
        "sse_first_event": "< 500ms",
        "concurrent_throughput": "5 uploads in < 10s",
        "cpu_usage": "< 15% during SSE parsing",
        "memory": "No leaks in 10-minute session"
      }
    },
    "critical_paths": [
      "US-501 → US-502 → US-503 → US-504 (Package setup and code generation)",
      "US-505 → US-506 (Adapter layer with SSE support)",
      "US-507 → US-509 → US-508 (Migration, VALIDATE, then cleanup)",
      "US-509 is now BLOCKING for US-508 (test before delete - consensus review fix)"
    ],
    "skip_if_behind_schedule": [
      "US-510 (Documentation - can be done incrementally)"
    ],
    "demo_scenario": "Build project → Read committed OpenAPI spec → Type-safe client generated → Scan book → Upload via generated client → Receive SSE events with compile-time safety → Book appears in library. Zero runtime JSON parsing errors. Deterministic builds work offline.",
    "risks": {
      "sse_support": "swift-openapi-generator may not natively support SSE - may need manual implementation",
      "breaking_changes": "API contract changes will break builds (intentional, but requires coordination)",
      "learning_curve": "Team must understand OpenAPI generator workflow and limitations",
      "MITIGATED_RISKS": {
        "build_time_fetch": "ELIMINATED - now commits specs to repo (consensus review fix)",
        "non_deterministic_builds": "ELIMINATED - specs are version controlled",
        "supply_chain_attack": "MITIGATED - checksum verification in update script",
        "offline_development": "FIXED - builds work without network"
      }
    },
    "consensus_review": {
      "date": "2026-01-24",
      "models_consulted": [
        "grok-code-fast-1",
        "gemini-2.5-flash",
        "gemini-3-pro-preview"
      ],
      "ratings": {
        "grok": "8/10",
        "gemini_flash": "9/10",
        "gemini_pro": "9/10",
        "consensus": "8.5/10 (after fixes: 9.5/10)"
      },
      "critical_fixes_applied": [
        "US-502: Changed from build-time spec fetch to committed specs + manual update script",
        "Dependency reorder: US-509 (test) now runs BEFORE US-508 (delete old code)",
        "US-509: Added comprehensive performance benchmarks (5 new tests)",
        "US-507: Added explicit rollback procedures with git commands",
        "All stories: Added recommendedTools (PAL MCP, planning-with-files)"
      ],
      "unanimous_agreement": [
        "Technical approach with swift-openapi-generator is sound",
        "Actor wrapper pattern (TalariaService) is correct",
        "Swift 6.2 concurrency alignment is excellent",
        "Build-time spec fetch is critical security/stability flaw",
        "Test-before-delete ordering is essential for safe migration"
      ]
    },
    "updatedAt": "2026-01-24T22:08:28.730Z",
    "reviewedBy": "Claude Code + PAL Consensus (Grok, Gemini 2.5 Flash, Gemini 3 Pro)"
  }
}